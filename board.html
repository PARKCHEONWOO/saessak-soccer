// 기존에 있던 변수들
let currentUserId = null;
let currentNickname = null;

// 닉네임 불러오는 비동기 함수
async function getNickname(uid) {
  const snap = await db.ref("users/" + uid).once("value");
  const val = snap.val();
  return val && val.nickname ? val.nickname : "익명";
}

auth.onAuthStateChanged(async user => {
  const postForm = document.getElementById("postForm");
  if (user) {
    currentUserId = user.uid;
    currentNickname = await getNickname(currentUserId);  // ✅ 닉네임 불러오기 완료
    postForm.style.display = "block";
  } else {
    postForm.innerHTML = '<p style="text-align:center;color:red;">로그인 후 글 작성이 가능합니다.</p>';
  }
  loadPosts();
});

async function submitPost() {
  const content = document.getElementById("content").value.trim();
  if (!content) return alert("내용을 입력해주세요.");

  // ✨ 다시 한번 닉네임 확인 보장
  if (!currentNickname && currentUserId) {
    currentNickname = await getNickname(currentUserId);
  }

  const postId = Date.now();
  await db.ref("posts/" + postId).set({
    uid: currentUserId,
    content: content,
    nickname: currentNickname || "익명",
    createdAt: new Date().toISOString()
  });

  document.getElementById("content").value = "";
  loadPosts();
}
